# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

环创店是一个基于Java Servlet的完整B2C蛋糕店Web应用，实现了用户管理、商品展示、购物车和订单管理等功能。项目采用MVC架构模式，使用经典三层结构（表现层、业务逻辑层、数据访问层）。该项目展示了传统Java Web开发的最佳实践，同时结合了现代化的前端用户体验设计。

## 技术架构

### 后端技术栈
- **核心框架**: Java Servlet 3.1.0, JSP, JSTL
- **数据库**: MySQL 8.0 (cake_shop数据库)
- **连接池**: C3P0 (v0.9.5.5) 精细优化配置
- **构建工具**: Maven 3.x
- **Java版本**: JDK 1.8
- **容器**: Apache Tomcat 8.5+
- **设计模式**: MVC, DAO, Service层, 单例模式

### 前端技术栈
- **基础技术**: HTML5, CSS3, JavaScript ES6
- **UI设计**: 响应式设计，支持移动端和桌面端
- **交互体验**: AJAX无刷新操作，懒加载无限滚动
- **CSS架构**: 模块化CSS架构，便于维护和扩展
- **搜索引擎**: 智能搜索建议，热门搜索，搜索历史

## 核心功能模块

### 1. 用户管理系统
- **用户注册**:
  - 用户信息验证（用户名、邮箱、手机号格式检查）
  - 用户名/邮箱唯一性检查
  - 密码MD5加密存储
  - 实时验证反馈
- **用户登录**:
  - 会话管理和状态保持
  - 密码验证机制
  - 记住登录状态功能
- **用户注销**: 安全会话清理
- **权限管理**: 普通用户/管理员权限区分
- **用户信息**: 个人信息查看和更新

### 2. 商品管理系统
- **商品展示**:
  - 多种展示方式（列表、网格）
  - 分类浏览功能
  - 全文搜索功能
  - 商品排序和筛选
- **商品分类**:
  - 多级分类管理（父子分类）
  - 动态分类导航
  - 分类商品筛选
- **推荐系统**:
  - Banner首页推荐
  - 热销商品推荐
  - 新品上市推荐
  - 个性化推荐算法
- **商品详情**:
  - 详细信息展示
  - 多图片展示
  - 库存实时显示
- **库存管理**: 实时库存更新和检查，防止超卖

### 3. 购物车系统
- **商品操作**:
  - 商品加入购物车（AJAX无刷新）
  - 数量增减管理
  - 商品删除和批量删除
  - 清空购物车
- **价格计算**:
  - 实时计算总价
  - 配送费计算
  - 优惠券和折扣支持
- **数据存储**: 基于Session的购物车数据管理
- **用户体验**:
  - 响应式设计
  - 购物车数量实时更新
  - 友好的交互提示

**主要页面**:
- `/cart` - 购物车主页面
- `/checkout.jsp` - 订单结算页面
- `/order-success.jsp` - 订单成功页面

### 4. 订单管理系统
- **订单创建**:
  - 支持多种支付方式
  - 配送费自动计算
  - 收货信息管理
- **订单管理**:
  - 订单状态跟踪
  - 订单取消功能
  - 订单历史查询
- **库存扣减**: 下单时自动减少库存，支持回滚
- **订单查询**: 用户订单列表和详情查询

### 5. 搜索系统（2025-12重大更新）
- **智能搜索框**:
  - 现代化UI设计（圆角、渐变、阴影）
  - 响应式布局适配
  - 动画效果和交互反馈
- **搜索建议**:
  - 实时搜索建议
  - 热门搜索词展示
  - 搜索历史记录
  - 模糊匹配支持
- **输入法优化**:
  - 完美支持中文拼音输入
  - 搜索框在输入过程中保持显示
  - 避免意外关闭问题
- **键盘导航**: 支持上下箭头键选择搜索建议
- **搜索增强**:
  - 搜索词高亮
  - 搜索结果统计
  - 搜索行为分析

## 项目结构详情

```
src/
├── main/
│   ├── java/com/sgu/cakeshopserive/
│   │   ├── servlet/                    # 控制器层 - 处理HTTP请求
│   │   │   ├── LoginServlet.java      # 用户登录处理
│   │   │   ├── RegisterServlet.java   # 用户注册处理
│   │   │   ├── LogoutServlet.java     # 用户注销处理
│   │   │   ├── GoodsServlet.java      # 商品管理和详情页核心控制器
│   │   │   ├── CartServlet.java       # 购物车操作控制器
│   │   │   ├── OrderServlet.java      # 订单管理控制器
│   │   │   └── TypeServlet.java       # 商品分类处理控制器
│   │   ├── service/                    # 业务逻辑层
│   │   │   ├── UserService.java       # 用户业务逻辑
│   │   │   ├── GoodsService.java      # 商品业务逻辑（包含推荐、搜索、分页）
│   │   │   ├── CartService.java       # 购物车业务逻辑
│   │   │   ├── OrderService.java      # 订单业务逻辑
│   │   │   └── TypeService.java       # 分类业务逻辑
│   │   ├── dao/                        # 数据访问层
│   │   │   ├── GoodsDao.java          # 商品数据访问对象
│   │   │   ├── TypeDao.java           # 分类数据访问对象
│   │   │   ├── UserDao.java           # 用户数据访问对象
│   │   │   └── OrderDao.java          # 订单数据访问对象
│   │   ├── model/                      # 数据模型层
│   │   │   ├── User.java              # 用户实体类
│   │   │   ├── Goods.java             # 商品实体类
│   │   │   ├── Type.java              # 分类实体类
│   │   │   ├── Order.java             # 订单实体类
│   │   │   ├── OrderItem.java         # 订单项实体类
│   │   │   └── PageResult.java        # 分页结果封装类
│   │   ├── common/                     # 通用组件
│   │   │   ├── Constants.java         # 系统常量定义
│   │   │   └── Result.java            # 统一响应结果封装
│   │   ├── filter/                     # 过滤器
│   │   │   ├── EncodeFilter.java      # 编码过滤器(全局UTF-8)
│   │   │   └── IndexFilter.java       # 首页数据加载过滤器
│   │   ├── listener/                   # 监听器
│   │   │   └── ApplicationServletContextListener.java # 应用生命周期管理
│   │   └── utils/                      # 工具类
│   │       ├── DBUtils.java           # 数据库连接池管理(单例模式)
│   │       ├── PasswordUtil.java      # 密码MD5加密工具
│   │       └── PriceUtil.java         # 价格处理工具
│   └── webapp/                         # Web资源目录
│       ├── WEB-INF/
│       │   └── web.xml               # Web应用部署描述符
│       ├── css/                        # 样式文件目录(模块化架构)
│       │   ├── main.css               # 主样式入口文件
│       │   ├── base.css               # 基础样式
│       │   ├── layout.css             # 布局样式
│       │   ├── header.css             # 头部样式
│       │   ├── components.css         # 组件样式
│       │   ├── footer.css             # 底部样式
│       │   └── pages/                 # 页面专用样式
│       │       ├── index.css          # 首页样式
│       │       ├── auth.css           # 认证页面样式
│       │       ├── goods.css          # 商品页面样式
│       │       ├── cart.css           # 购物车样式
│       │       └── recommend.css      # 推荐页面样式
│       ├── images/                     # 图片资源目录
│       │   ├── products/              # 商品图片
│       │   ├── banners/               # 轮播图
│       │   └── icons/                 # 图标资源
│       ├── index.jsp                   # 首页
│       ├── login.jsp                   # 登录页面
│       ├── register.jsp                # 注册页面
│       ├── goods-detail.jsp            # 商品详情页
│       ├── cart.jsp                    # 购物车页面
│       ├── checkout.jsp                # 结算页面
│       ├── order-success.jsp           # 订单成功页面
│       ├── search.jsp                  # 搜索结果页面
│       ├── category.jsp                # 分类页面
│       ├── hot-sales.jsp               # 热销商品页面
│       ├── new-arrivals.jsp            # 新品页面
│       ├── error.jsp                   # 错误页面
│       └── js/                         # JavaScript脚本目录
│           ├── search-enhance.js       # 搜索框增强脚本(2025-12新增)
│           ├── lazy-load.js            # 商品懒加载脚本
│           └── cart.js                 # 购物车脚本
├── test/                               # 测试代码目录
└── reference_document/                  # 参考文档目录
    ├── cake_shop.sql                  # 数据库结构和完整数据SQL
    ├── test_data.sql                  # 测试数据SQL
    └── test_categories.sql            # 商品分类测试数据
```

### 项目包结构特点
1. **清晰的分层架构**: 严格遵循MVC设计模式，职责分明，便于维护
2. **模块化设计**: 按功能模块（用户、商品、订单、分类）组织代码
3. **完整的工具支持**: utils包提供数据库连接、密码加密、价格处理等工具类
4. **安全机制**: filter包实现编码处理，listener包管理应用生命周期
5. **统一响应格式**: common包的Result类提供统一的API响应格式
6. **测试支持**: 完整的测试包结构，支持单元测试和集成测试

## 核心依赖 (pom.xml)

### 主要依赖
- **Servlet API**: 3.1.0 (provided scope)
- **MySQL Connector**: 8.0.33
- **C3P0连接池**: 0.9.5.5
- **JUnit 5**: 5.10.2 (测试框架)

### 依赖管理
- 所有依赖版本统一管理
- 开发和生产环境依赖分离
- 依赖冲突已解决

## 数据库设计

### 完整表结构
1. **user**: 用户表
   - `user_id` (主键), `username`, `password` (MD5加密), `real_name`, `email`, `phone`, `address`, `is_admin`, `is_active`, `create_time`

2. **goods**: 商品表
   - `goods_id` (主键), `goods_name`, `cover_image`, `detail_image`, `price`, `description`, `stock`, `type_id`, `create_time`, `update_time`

3. **type**: 分类表
   - `type_id` (主键), `type_name`, `parent_id`, `sort_order`, `create_time`

4. **recommend**: 推荐表
   - `recommend_id` (主键), `goods_id`, `recommend_type` [banner/hot/new], `sort_order`, `create_time`

5. **order_table**: 订单表
   - `order_id` (主键), `total_amount`, `total_quantity`, `payment_status`, `payment_method`, `shipping_info`, `order_time`, `user_id`

6. **orderitem**: 订单项表
   - `orderitem_id` (主键), `goods_price`, `quantity`, `goods_id`, `order_id`

### 数据库连接配置
- **URL**: `jdbc:mysql://localhost:3306/cake_shop?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8&autoReconnect=true&useSSL=false`
- **用户名**: `root`
- **密码**: `root`

### 优化连接池配置
```java
// 文件：/src/main/java/com/sgu/cakeshopserive/utils/DBUtils.java
- 初始连接数: 3
- 最小连接数: 3
- 最大连接数: 10
- 连接超时: 30秒
- 最大空闲时间: 3分钟
- 连接泄露检测: 5分钟超时
- 支持连接池监控和调试
```

## 已实现的优化特性

### 1. 架构优化
- **MVC分层**: 实现了清晰的MVC三层架构
- **Service层**: 引入业务逻辑层，分离业务和数据访问
- **统一返回**: Result封装类提供统一的API响应格式
- **常量管理**: Constants类集中管理系统常量和配置
- **资源管理**: ApplicationServletContextListener管理应用生命周期，防止内存泄漏

### 2. 数据库优化
- **连接池优化**: C3P0连接池配置经过调优，支持连接泄露检测
- **SQL优化**: 使用PreparedStatement防止SQL注入
- **外键约束**: 完善的数据库外键约束保证数据完整性
- **索引设计**: 为关键字段建立索引提升查询性能
- **分页查询**: 实现了高效的分页查询机制

### 3. 代码质量提升
- **异常处理**: 在Service层实现统一的异常处理和错误返回
- **参数验证**: 完善的输入参数验证和格式检查
- **资源管理**: 使用try-with-resources确保数据库连接正确关闭
- **编码规范**: 统一的UTF-8编码处理
- **调试优化**: 移除了所有控制台调试输出，避免编码问题

### 4. 前端优化
- **模块化CSS**: 采用CSS模块化架构，便于维护和扩展
- **响应式设计**: 完善的移动端和桌面端适配
- **AJAX支持**: 购物车等功能采用AJAX提升用户体验
- **懒加载实现**: 商品列表无限滚动，减少初始加载时间
- **搜索功能增强**: 实现现代化的搜索框交互体验

### 5. 搜索功能优化（2025-12重大更新）
- **现代化搜索框设计**: 采用圆角设计、渐变背景和多层阴影效果
- **智能搜索建议**: 支持实时搜索建议和热门搜索词展示
- **搜索历史记录**: 基于localStorage的用户搜索历史管理
- **中文输入法优化**: 完美支持中文拼音输入，避免搜索框意外关闭
- **键盘导航支持**: 支持上下箭头键选择搜索建议
- **响应式搜索体验**: 移动端和桌面端都有优化的搜索体验

### 6. 热销和新品页面优化（2025-12更新）
- **独立页面**: 创建了专门的热销商品页面(`hot-sales.jsp`)和新品页面(`new-arrivals.jsp`)
- **懒加载集成**: 热销和新品商品支持懒加载无限滚动
- **状态管理**: 修复了加载状态显示问题，提供更好的用户体验
- **SEO优化**: 独立的URL路径有利于搜索引擎优化

## 安全特性

### 当前实现
1. **密码安全**: 使用MD5哈希算法加密存储(建议升级到BCrypt)
2. **输入验证**: 前后端双重验证，防止XSS和SQL注入
3. **会话管理**: 30分钟自动超时，安全退出机制
4. **编码处理**: 统一UTF-8编码，防止中文乱码
5. **SQL注入防护**: 全程使用PreparedStatement
6. **权限控制**: 基于Session的用户认证和权限检查

### 安全改进建议
1. **密码加密**: 升级到BCrypt或PBKDF2
2. **CSRF防护**: 实现CSRF令牌验证
3. **会话安全**: 实现会话固定保护
4. **配置安全**: 使用配置文件管理敏感信息

## 内存泄漏优化（2025-12新增）

### 资源清理机制
创建了`ApplicationServletContextListener`来管理应用资源：
- **C3P0连接池清理**: 应用停止时自动关闭连接池
- **JDBC驱动注销**: 防止驱动程序未注销警告
- **MySQL线程清理**: 清理MySQL连接清理线程
- **强制垃圾回收**: 释放内存资源

### 已解决的警告
- JDBC driver未正确注销
- C3P0连接池线程未停止
- MySQL连接清理线程泄漏
- ObjectStreamClass缓存问题

## 开发规范

### 代码规范
1. **包命名**: `com.sgu.cakeshopserive.{module}`
2. **类命名**: 驼峰命名法，Servlet以Servlet结尾，Service以Service结尾
3. **数据库表**: 小写+下划线命名
4. **JSP文件**: 小写+中划线命名
5. **常量定义**: 使用Constants类集中管理

### 编码规范
1. **字符编码**: 全项目UTF-8编码
2. **数据库字符集**: utf8mb4
3. **连接字符集**: useUnicode=true&characterEncoding=utf-8
4. **代码风格**: 遵循Java标准编码规范

### 安全开发规范
1. **SQL操作**: 使用PreparedStatement防止SQL注入
2. **用户输入**: 必须进行合法性验证和XSS防护
3. **密码处理**: 加密存储，不存储明文密码
4. **会话管理**: 合理设置超时时间，实现安全退出
5. **资源管理**: 使用try-with-resources确保资源正确关闭

## 调试和测试

### 调试配置
- **IDE**: 支持断点调试和热部署
- **日志**: 已移除控制台调试输出，建议集成Log4j或SLF4J
- **浏览器**: Chrome开发者工具进行前端调试
- **数据库**: 使用MySQL Workbench或类似工具

### 测试
- **单元测试**: JUnit 5 (已配置)
- **集成测试**: Servlet容器内测试
- **浏览器测试**: 支持Chrome、Firefox、Edge等主流浏览器
- **压力测试**: 建议进行并发用户测试

## 主要功能流程

### 购物车完整流程
1. **添加商品**:
   - 用户在商品详情页点击"加入购物车"
   - AJAX请求到`/cart?action=add&goodsId=1`
   - 库存检查和数量更新
2. **购物车管理**:
   - 访问`/cart`查看购物车
   - 支持数量修改、删除商品、清空购物车
   - 实时价格计算
3. **结算流程**:
   - 点击"去结算"跳转到`/checkout.jsp`
   - 填写收货信息选择支付方式
   - 订单确认和提交
4. **订单完成**:
   - 创建订单记录并扣减库存
   - 跳转到`/order-success.jsp`显示订单信息
   - 发送订单确认邮件(可扩展)

### 商品分类功能
1. **分类数据加载**: 页面加载时自动AJAX请求`/type?action=ajax`获取分类列表
2. **分类展示**: 导航栏"商品分类"下拉菜单动态显示所有分类
3. **分类浏览**: 点击分类跳转到`/goods?action=type&typeId=X`显示该分类商品

### 搜索完整流程（2025-12优化）
1. **搜索框交互**:
   - 鼠标悬浮或点击搜索图标显示搜索框
   - 支持实时搜索建议和热门搜索
2. **搜索建议系统**:
   - 输入关键词时动态显示相关商品建议
   - 支持键盘导航和鼠标选择
3. **搜索历史管理**:
   - localStorage存储搜索历史
   - 支持清除历史和快速访问
4. **搜索执行**:
   - 表单提交到`/goods?action=search&keyword=关键词`
   - 支持商品名称、描述等多字段搜索
5. **结果展示**:
   - 分页展示搜索结果
   - 高亮显示搜索关键词

### 热销和新品浏览流程（2025-12新增）
1. **页面访问**:
   - 热销商品: `/goods?action=hot` → `hot-sales.jsp`
   - 新品上市: `/goods?action=new` → `new-arrivals.jsp`
2. **懒加载**:
   - 页面加载时显示加载状态
   - 无限滚动加载更多商品
3. **交互体验**:
   - 商品详情查看
   - 直接加入购物车
   - 响应式布局适配

## 部署和运维

### 部署要求
- **Java环境**: JDK 1.8+
- **Web容器**: Apache Tomcat 8.5+
- **数据库**: MySQL 8.0+
- **内存配置**: 最小512MB，推荐1GB+

### 部署步骤
1. 数据库初始化：执行`cake_shop.sql`创建数据库和表结构
2. 导入测试数据：执行`test_data.sql`（可选）
3. 配置数据库连接：检查`DBUtils.java`中的连接参数
4. 构建项目：`mvn clean package`
5. 部署WAR包：将生成的WAR文件部署到Tomcat
6. 启动应用：访问`http://localhost:8080/CakeShop/`

### 监控和维护
- **内存监控**: 使用ApplicationServletContextListener防止内存泄漏
- **性能监控**: 建议集成APM工具监控应用性能
- **日志管理**: 建议集成日志系统进行日志收集和分析
- **备份策略**: 定期备份数据库和重要文件

## 扩展开发指南

### 添加新功能模块
1. 创建对应的Model实体类（在`model`包下）
2. 实现DAO层数据访问（在`dao`包下）
3. 编写Service业务逻辑（在`service`包下）
4. 创建Servlet控制器（在`servlet`包下）
5. 编写JSP视图页面（在`webapp`目录下）
6. 配置路由映射（如需要）
7. 添加相应的CSS样式（在`css/pages/`目录下）

### 数据库表扩展
1. 设计数据库表结构和索引
2. 编写创建表的SQL脚本
3. 更新对应的Model实体类
4. 实现DAO层CRUD操作
5. 编写Service业务逻辑
6. 添加单元测试

### 前端功能扩展
1. **CSS样式**: 在`css/pages/`目录下创建页面专用CSS
2. **JavaScript模块**: 在`js/`目录下创建功能脚本
3. **响应式设计**: 遵循现有的响应式设计规范
4. **用户体验**: 保持与现有设计风格一致

### 搜索功能扩展
1. **修改搜索数据源**: 更新`search-enhance.js`中的`fetchSuggestions`方法
2. **添加搜索API**: 在GoodsServlet中实现搜索建议API
3. **扩展搜索范围**: 支持商品描述、分类等多字段搜索
4. **添加搜索统计**: 记录用户搜索行为和热门搜索词
5. **优化搜索算法**: 实现模糊匹配、同义词、拼音搜索等

## 性能优化建议

### 数据库优化
1. **索引优化**: 为查询频繁的字段添加适当索引
2. **查询优化**: 优化复杂查询语句，避免N+1问题
3. **连接池调优**: 根据实际负载调整连接池参数
4. **读写分离**: 考虑实现数据库读写分离

### 应用层优化
1. **缓存机制**: 引入Redis等缓存层，缓存热点数据
2. **异步处理**: 对于耗时操作考虑异步处理
3. **分页优化**: 实现更高效的分页查询
4. **并发控制**: 优化高并发场景下的性能

### 前端优化
1. **资源压缩**: 压缩CSS、JS和图片资源
2. **CDN加速**: 使用CDN加速静态资源访问
3. **懒加载**: 扩展懒加载机制到更多场景
4. **代码分离**: 实现前端代码模块化和按需加载

## 版本历史

- **v1.0**: 基础功能实现，包括用户管理、商品展示、购物车
- **v1.1**: 添加订单管理系统
- **v1.2**: 优化CSS架构，实现模块化样式
- **v1.3**: 完善异常处理和参数验证
- **v1.4**: 优化数据库连接池配置
- **v1.5**: 完善商品分类功能，修复导航栏分类显示问题
- **v1.6**: 搜索功能全面优化（2025-12），包括：
  - 现代化搜索框UI设计
  - 智能搜索建议和热门搜索
  - 搜索历史记录功能
  - 完美支持中文输入法
  - 键盘导航支持
  - 响应式搜索体验
- **v1.7**: 热销和新品页面优化（2025-12），包括：
  - 独立的热销和新品页面
  - 懒加载集成
  - 加载状态优化
  - 内存泄漏修复
  - 控制台输出清理

## 贡献指南

1. **遵循规范**: 遵循现有的代码规范和架构模式
2. **测试覆盖**: 为新功能编写相应的单元测试
3. **文档更新**: 及时更新相关文档和注释
4. **代码审查**: 提交前进行代码审查和测试
5. **向后兼容**: 确保新功能不破坏现有功能
6. **性能考虑**: 考虑新功能对系统性能的影响

## 常见问题解决

### 开发环境问题
1. **数据库连接失败**: 检查MySQL服务状态和连接参数
2. **中文乱码**: 确保数据库、连接和应用都使用UTF-8编码
3. **页面404**: 检查Servlet映射和JSP文件路径
4. **依赖冲突**: 使用`mvn dependency:tree`分析依赖关系

### 部署问题
1. **内存溢出**: 调整JVM内存参数
2. **性能问题**: 启用数据库连接池监控
3. **文件路径**: 注意不同操作系统的文件路径差异
4. **端口冲突**: 修改Tomcat默认端口

### 功能问题
1. **购物车数据丢失**: 检查Session配置和超时设置
2. **搜索无结果**: 检查数据库数据和搜索逻辑
3. **图片不显示**: 检查图片路径和文件权限
4. **订单创建失败**: 检查库存和数据库事务

## 技术支持

如有技术问题，请通过以下方式获取帮助：
1. 查看项目文档和代码注释
2. 检查日志文件和错误信息
3. 参考常见问题解决方案
4. 联系开发团队获取支持